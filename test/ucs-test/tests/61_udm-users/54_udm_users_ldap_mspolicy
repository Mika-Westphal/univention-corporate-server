#!/usr/share/ucs-test/runner python
## desc: Test users/user and users/ldap mspolicy password functionality
## tags: [udm]
## roles: [domaincontroller_master]
## exposure: dangerous
## packages: [python-univention-directory-manager]
## bugs: [52446]

import pytest

import univention.testing.utils as utils
import univention.testing.udm as udm_test
import univention.testing.ucr as ucr_test
import univention.testing.strings as uts
from univention.config_registry import handler_set


if __name__ == '__main__':

	with udm_test.UCSTestUDM() as udm, ucr_test.UCSTestConfigRegistry() as ucr:
		handler_set(['password/quality/mspolicy=true'])
		lo = utils.get_ldap_connection()
		attr = dict(name='%s' % (uts.random_username()), pwQualityCheck='TRUE')
		pol_dn = udm.create_object('policies/pwhistory', wait_for_replication=True, check_for_drs_replication=True, wait_for=True, **attr)
		utils.wait_for_replication_and_postrun()

		for module in ['users/user', 'users/ldap']:
			name = "%s_test1" % (uts.random_username())
			attr = dict(password='Univention.1', username=name, lastname='test', policy_reference=pol_dn)
			dn = udm.create_object(module, wait_for_replication=True, check_for_drs_replication=True, wait_for=True, **attr)

			with pytest.raises(udm_test.UCSTestUDM_ModifyUDMObjectFailed):
				udm.modify_object(module, dn=dn, password='univention')

			with pytest.raises(udm_test.UCSTestUDM_ModifyUDMObjectFailed):
				udm.modify_object(module, dn=dn, password='Uni1%s' % (name,))

			if module == 'users/user':
				with pytest.raises(udm_test.UCSTestUDM_ModifyUDMObjectFailed):
					udm.modify_object(module, dn=dn, password='Uni.1test1')
