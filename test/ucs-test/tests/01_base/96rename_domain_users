#!/usr/share/ucs-test/runner python
## desc: Rename Domain Users
## tags:
##  - basic
##  - rename_default_account
##  - skip_admember
## roles:
##  - domaincontroller_master
##  - domaincontroller_backup
##  - domaincontroller_slave
##  - memberserver
## exposure: dangerous


import subprocess
import univention.config_registry
from univention.testing.ucr import UCSTestConfigRegistry
from univention.testing.udm import UCSTestUDM
import univention.testing.utils as utils
import univention.testing.strings as uts
import re
import os
import glob
import fnmatch
import time

def search_templates(old_group_name, new_group_name):
	templates = glob.glob('/etc/univention/templates/info/*.info')
	file_content = []
	match_filter = '^(Multifile: |File: )'
	# find all template files by iterating over all referenced templates in the ucr *.info files
	for template in templates:
		with open(template, 'r') as content_file:
			# find all lines that start with File or Multifile and strip it to get the paths of the template files
			file_content += ['/' + re.sub(match_filter, '', l).strip() for l in content_file.readlines() if re.match(match_filter, l)]
	
	file_content = list(dict.fromkeys(file_content))
	for file in file_content:
		if os.path.isfile(file):
			print('Checking template %s' % (file,))
			with open(file, 'r') as content_file:
				# /etc/security/limits.conf contains a comment about Domain Users which we will ignore.
				# But it must contain the new name of the default domainusers group
				if file == "/etc/security/limits.conf":
					if not new_group_name in content_file.read():
						print(content_file.read())
						utils.fail('FAIL: New group name %s not in security conffiles' % (new_group_name,))
				else:
					if old_group_name in content_file.read():
						utils.fail('FAIL: Domain Users still in template files')
		else:
			print('template not found %s' % (file,))


def test_rename_domain_users():
	with UCSTestConfigRegistry() as ucr_test:
		ucr_test.load()

		ldap_base = ucr_test.get('ldap/base')
		old_group_name = ucr_test.get('groups/default/domainusers', 'Domain Users')
		old_group_dn = "cn=%s,cn=groups,%s" % (old_group_name, ldap_base)

		new_group_name = uts.random_name()
		new_group_dn = "cn=%s,cn=groups,%s" % (new_group_name, ldap_base)
		try:
			print('\n##################################################################')
			print('Renaming default domainusers group %s to %s' % (old_group_name, new_group_name))
			print('##################################################################\n')
			cmd = (['udm', 'groups/group', 'modify', '--dn=%s' %(old_group_dn), '--set', 'name=%s' %(new_group_name)])
			subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=False)
			utils.wait_for_replication_and_postrun()
			# Check UCR Variable
			print('\n##################################################################')
			print('Checking if UCR Variable groups/default/domainusers is set to %s' %(new_group_name,))
			print('##################################################################\n')
			ucr_test.load()
			ucr_domainusers = ucr_test.get('groups/default/domainusers', 'Domain Users')
			if not new_group_name in ucr_domainusers:
				utils.fail('UCR variable groups/default/domainusers was not set to %s' % (ucr_domainusers,))
				print(ucr_test.get('groups/default/domainusers', 'Domain Users'))
			else:
				print('UCR variable groups/default/domainusers is set correctly to %s' % (ucr_domainusers,))

			# Search templates
			print('\n##################################################################')
			print('Search templates for old and new name of default domainusers group')
			print('##################################################################\n')
			search_templates(old_group_name, new_group_name)
		finally:
			try:
				utils.wait_for_s4connector_replication()
			except Exception:
				# clean up even if the wait_for method fails and wait a bit if it terminated at the beginning
				time.sleep(10)
				pass
			print('\n##################################################################')
			print('Cleanup')
			print('##################################################################\n')
			cmd = (['udm', 'groups/group', 'modify', '--dn=%s' %(new_group_dn), '--set', 'name=%s' %(old_group_name)])
			subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=False)


if __name__ == '__main__':
	test_rename_domain_users()
